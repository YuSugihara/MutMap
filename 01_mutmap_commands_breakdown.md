# MutMap Commands Breakdown

This document provides a comprehensive overview of the commands used in the MutMap pipeline. By understanding each step's purpose, usage, and the default parameters employed in MutMap, users may be able to run the bash commands independently to troubleshoot and resolve issues more effectively. The goal is to help users better understand the internal workings of MutMap and ensure efficient execution.

## Table of Contents

1. [Step 1: Directory Setup](#step-1-directory-setup)
2. [Step 2: Quality Control and Trimming](#step-2-quality-control-and-trimming)
3. [Step 3: Reference Genome Indexing](#step-3-reference-genome-indexing)
4. [Step 4: Read Alignment and BAM Processing](#step-4-read-alignment-and-bam-processing)
5. [Step 5: BAM Sorting and Indexing](#step-5-bam-sorting-and-indexing)
6. [Step 6: Variant Calling with mpileup](#step-6-variant-calling-with-mpileup)
7. [Step 7: SNP Filtering, SNP Index Calculation, and Visualization with MutPlot](#step-7-snp-filtering-snp-index-calculation-and-visualization-with-mutplot)

---

## Step 1: Directory Setup

Before starting the pipeline, ensure that all necessary directories are created. This prevents errors from occurring when output directories are missing. The following structure should be in place:

```bash
mkdir -p output_directory/00_fastq
mkdir -p output_directory/10_ref
mkdir -p output_directory/20_bam
mkdir -p output_directory/30_vcf
```

- **00_fastq**: For storing filtered FASTQ files.
- **10_ref**: For storing reference genome index files.
- **20_bam**: For storing BAM files after alignment.
- **30_vcf**: For storing the VCF files generated by variant calling.

---

## Step 2: Quality Control and Trimming

**Description**:\
Trimming is the process of removing low-quality sequences and adapters from raw sequencing data. This step is essential to ensure that the data used for alignment is clean and of high quality. In MutMap, trimming is performed using **Trimmomatic** on both the **cultivar** and **mutant bulk** in the same manner.

**Usage**:

```bash
trimmomatic PE -threads 4 \
               -phred33 input_R1.fastq.gz input_R2.fastq.gz \
               output_directory/00_fastq/output_R1_paired.fastq.gz \
               output_directory/00_fastq/output_R1_unpaired.fastq.gz \
               output_directory/00_fastq/output_R2_paired.fastq.gz \
               output_directory/00_fastq/output_R2_unpaired.fastq.gz \
               ILLUMINACLIP:adapter.fasta:2:30:10 \
               LEADING:20 \
               TRAILING:20 \
               SLIDINGWINDOW:4:15 \
               MINLEN:75
```

**Explanation**:

- `PE`: Specifies paired-end mode.
- `ILLUMINACLIP`: Trims adapter sequences based on the adapter file provided.
- `LEADING`: Trims low-quality bases from the beginning of the read.
- `TRAILING`: Trims low-quality bases from the end of the read.
- `SLIDINGWINDOW`: Performs sliding window trimming, trimming when the average quality within the window falls below a threshold.
- `MINLEN`: Discards reads that are shorter than the specified length.

**Note**: The options and parameters introduced here are the default values used within MutMap.

**Additional Information**:

1. **Trimmomatic GitHub Repository**: For more information on Trimmomatic, refer to its [GitHub repository](https://github.com/usadellab/Trimmomatic).

2. **Adapter Sequences**: The adapter sequences used in the trimming process can be found on the [Trimmomatic GitHub](https://github.com/timflutre/trimmomatic/tree/master/adapters). However, these should be selected based on the specific experimental design. It is important to verify which adapter sequences are most appropriate for your dataset.

3. **Creating Adapter FASTA Files**: A useful explanation on how to properly prepare adapter FASTA files, particularly when using the NEB library, can be found in this [issue](https://github.com/usadellab/Trimmomatic/issues/20). This provides insights into why certain adapter formats are necessary.

4. **Quality Control**: After trimming, it is recommended to perform quality control (QC) on the resulting FASTQ files using software like [FastQC](https://github.com/s-andrews/FastQC).

5. **Alternative Software - fastp**: If you are unsure about which adapter sequences were used, the software [fastp](https://github.com/OpenGene/fastp) may be useful. It includes the `--detect_adapter_for_pe` option, which automatically detects and removes adapter sequences. However, please note that MutMap has not been extensively tested with fastp, so its compatibility cannot be guaranteed.

---

## Step 3: Reference Genome Indexing

**Description**:\
Before aligning reads to the reference genome, the genome must be indexed. Indexing creates necessary data structures that make the alignment process more efficient. In MutMap, **BWA** and **SAMtools** are used for reference genome indexing. For more information on SAMtools, please refer to the [SAMtools Manual](https://www.htslib.org/doc/samtools.html). Additionally, for more information on BWA, refer to the [BWA Manual](https://bio-bwa.sourceforge.net/bwa.shtml).

**Reference Genome Indexing**:

```bash
# Create a symbolic link to reference genome in 10_ref
ln -s reference_genome.fasta output_directory/10_ref/reference_genome.fasta

# Index the reference genome using BWA
bwa index output_directory/10_ref/reference_genome.fasta

# Index the reference genome using SAMtools
samtools faidx output_directory/10_ref/reference_genome.fasta
```

---

## Step 4: Read Alignment and BAM Processing

**Description**:\
Alignment is performed on both the **cultivar** and **mutant bulk** in the same manner. After trimming and indexing the reference genome, the next step is to align the sequencing reads to the reference using **BWA**, followed by **SAMtools** for processing the SAM/BAM files.

**Alignment and BAM Processing**:

```bash
bwa mem -t 4 output_directory/10_ref/reference input_R1.fastq.gz input_R2.fastq.gz | \
samtools fixmate -m - - | \
samtools sort -m 1G -@ 4 | \
samtools markdup -r - - | \
samtools view -b -f 2 -F 2048 -o output_directory/20_bam/sample.bam
```

**Explanation**:

- `mem`: Algorithm for aligning paired-end reads.
- `-t 4`: Specifies the number of threads to use.
- `fixmate`: Adjusts mate-pair information to ensure consistency.
- `-m`: Specifies the maximum memory available per thread for sorting (e.g., `-m 1G` limits memory usage to 1 GB).
- `sort`: Sorts the BAM file by genomic coordinate.
- `-@`: Specifies the number of threads to use for sorting (e.g., `-@ 4` uses 4 threads).
- `markdup`: Removes duplicate reads, which are often artifacts of PCR amplification, to avoid bias in variant calling.
- `view`: Converts the data into BAM format.
- `-b`: Outputs in BAM format.
- `-f 2`: Selects only properly paired reads (both reads in the pair are mapped).
- `-F 2048`: Excludes supplementary alignments.

---

## Step 5: BAM Sorting and Indexing

**Description**:\
Sorting and indexing are performed on both the **cultivar** and **mutant bulk** in the same manner. After aligning the reads, **SAMtools** is used to sort and index the resulting BAM files for efficient access and analysis. Sorting ensures that the reads are ordered by their position in the genome, and indexing creates a .bai file that allows for fast retrieval of specific regions during analysis.

**Usage**:

```bash
samtools sort -m 1G -@ 4 -o output_directory/20_bam/cultivar.bam output_directory/20_bam/cultivar.unsorted.bam
samtools index output_directory/20_bam/cultivar.bam

samtools sort -m 1G -@ 4 -o output_directory/20_bam/bulk.bam output_directory/20_bam/bulk.unsorted.bam
samtools index output_directory/20_bam/bulk.bam
```

**Explanation**:

- `sort`: Sorts the BAM file by genomic coordinates, which is essential for downstream processing.
- `-m 1G`: Limits memory usage per thread to 1 GB.
- `-@ 4`: Uses 4 threads for sorting.
- `index`: Creates an index file (.bai) for the sorted BAM file, allowing for fast retrieval of specific genomic regions.

### Note for Large Genomes (e.g., Wheat):

For larger genomes like wheat, using the default `samtools index` may lead to inefficiencies or errors due to the size of the BAM file

. In such cases, it is recommended to use the `-c` option to create a CSI index for both **cultivar** and **mutant bulk** BAM files:

```bash
samtools index -c output_directory/20_bam/cultivar.bam
samtools index -c output_directory/20_bam/bulk.bam
```

This creates CSI indexes, which support larger reference genomes.

---

## Step 6: Variant Calling with mpileup

**Description**:\
Once the BAM files are indexed, the next step is to call variants using **bcftools mpileup** and **bcftools call**. The `AD`, `ADF`, and `ADR` fields are critical for MutMap, as they provide allele depth information that is essential for the analysis. This command identifies SNPs and other variants in the sequencing data. For more information, refer to the [BCFtools Manual](https://www.htslib.org/doc/bcftools.html) and the [Tabix Manual](https://www.htslib.org/doc/tabix.html).

**Usage**:

```bash
bcftools mpileup -a AD,ADF,ADR -B -q 40 -Q 18 -C 50 -O u -f output_directory/10_ref/reference.fasta \
output_directory/20_bam/cultivar.bam output_directory/20_bam/bulk.bam | \
bcftools call -vm -f GQ,GP -O u | \
bcftools filter -i "INFO/MQ>=40" -O z -o output_directory/30_vcf/mutmap.vcf.gz
```

**Explanation**:

- `mpileup`: Generates per-base information for each position in the reference genome.
- `-a AD,ADF,ADR`: Includes allele depth information in the output. These fields are crucial for MutMap analysis.
- `-B`: Disables BAQ computation.
- `-q 40`: Filters reads with mapping quality less than 40.
- `-Q 18`: Filters bases with base quality less than 18.
- `-C 50`: Adjusts the mapping quality to account for the use of BWA during alignment.

**Chromosome-specific processing**:\
The `-r` option in `bcftools mpileup` allows for chromosome-specific processing, which can be used to parallelize the VCF generation for each chromosome individually.

**Concatenating VCF Files**:

If the VCF files are generated separately for each chromosome, you can use `bcftools concat` to concatenate them into a single VCF file for easier analysis.

**Usage**:

```bash
bcftools concat -O z -o output_directory/30_vcf/mutmap_combined.vcf.gz output_directory/30_vcf/mutmap.chr*.vcf.gz
```

This command will concatenate all chromosome-specific VCF files (`mutmap.chr*.vcf.gz`) into a single compressed VCF file (`mutmap_combined.vcf.gz`).

**Index the VCF file with Tabix**:

```bash
tabix -f -p vcf output_directory/30_vcf/mutmap.vcf.gz
```

### Note for Large Genomes (e.g., Wheat):

For large genomes like wheat, using the default `tabix` indexing may not be sufficient. In such cases, use the `-C` option to create a CSI index that supports large reference genomes:

```bash
tabix -C -p vcf output_directory/30_vcf/mutmap.vcf.gz
```

This ensures compatibility with large genomes and allows for efficient access to the data.

---

## Step 7: SNP Filtering, SNP Index Calculation, and Visualization with MutPlot

**Description**:\
MutPlot is used to filter SNPs, calculate SNP indices, and visualize the results. It helps identify significant SNPs and their impact on the genome, producing various files that assist in analyzing and visualizing the data.  For more information on MutPlot outputs, please refer to the [MutMap GitHub Outputs section](https://github.com/YuSugihara/MutMap/tree/master?tab=readme-ov-file#outputs).

**Usage**:

```bash
mutplot -v output_directory/30_vcf/mutmap.vcf.gz -o output_directory/40_plot -n 20
```

**Required Options**:

- `-v`: Specifies the input VCF file generated by the variant calling step.
- `-o`: Specifies the output directory for the visualization results.
- `-n`: Specifies the number of individuals in the mutant bulk, which is necessary for proper analysis.

**Optional: Using MutPlot with SnpEff**:\
MutPlot can be run in combination with **SnpEff** to annotate variants for their potential effects. This allows for a more detailed understanding of how SNPs may impact gene function. For more information on SnpEff, please refer to the [SnpEff Documentation](https://pcingola.github.io/SnpEff/snpeff/introduction/).

**Usage**:

```bash
mutplot -v output_directory/30_vcf/mutmap.vcf.gz -o output_directory/40_plot -n 20 -e database
```

**Additional Option**:

- `-e database`: Specifies the SnpEff database to use for annotating variants. Ensure that the correct SnpEff database is installed and available before running this command.
